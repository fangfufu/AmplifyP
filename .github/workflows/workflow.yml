name: AmplifyP post-commit

on:
  pull_request:
  push:
    branches: [master]

permissions:
  contents: read

jobs:
  run:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.12', '3.13', '3.14']
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    - name: Display Python version
      run: python --version
    - name: Install pytest
      run: |
        pip install pytest-cov
    - name: Set TCL/TK env vars (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        $pythonPath = python -c "import sys; print(sys.base_prefix)"
        Write-Host "Python Path: $pythonPath"
        # Find init.tcl
        $tclFile = Get-ChildItem -Path $pythonPath -Filter "init.tcl" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($tclFile) {
            $tclDir = Split-Path $tclFile.FullName
            Write-Host "Found TCL_LIBRARY: $tclDir"
            echo "TCL_LIBRARY=$tclDir" >> $env:GITHUB_ENV
        } else {
            Write-Warning "Could not find init.tcl"
        }
        # Find tk.tcl
        $tkFile = Get-ChildItem -Path $pythonPath -Filter "tk.tcl" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($tkFile) {
            $tkDir = Split-Path $tkFile.FullName
            Write-Host "Found TK_LIBRARY: $tkDir"
            echo "TK_LIBRARY=$tkDir" >> $env:GITHUB_ENV
        } else {
            Write-Warning "Could not find tk.tcl"
        }
    - name: Install system dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb python3-tk
    - name: Run pytest
      shell: bash
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          xvfb-run -a coverage run -m pytest
        else
          coverage run -m pytest
        fi
    - name: Display coverage report
      run: |
        coverage report -m
    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
